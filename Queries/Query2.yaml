query: |
  SELECT start,
         end,
         varBP,
         varFF,
         cnt
  FROM (
      SELECT start,
             end,
             VAR(PCFA_mbar) AS varBP,
             VAR(PCFF_mbar) AS varFF,
             COUNT(time_utc) AS cnt
      FROM sncb_stream
      WHERE temporal_eintersects_geometry(gps_lon,
                                          gps_lat,
                                          time_utc,
                                          'SRID=4326;POLYGON((4.0 50.0, 4.0 50.8, 4.6 50.8, 4.6 50.0, 4.0 50.0))') = INT32(0)
      WINDOW SLIDING(time_utc, SIZE 10 SEC, ADVANCE BY 200 MS) 
  )
  WHERE (varBP > FLOAT64(0.1))
    AND (varFF <= FLOAT64(10))
  INTO file_sink;

sinks:
  - name: FILE_SINK
    type: File
    schema:
      - { name: SNCB_STREAM$START,  type: UINT64 }
      - { name: SNCB_STREAM$END,    type: UINT64 }
      - { name: SNCB_STREAM$VARBP,  type: FLOAT64 }
      - { name: SNCB_STREAM$VARFF,  type: FLOAT64 }
      - { name: SNCB_STREAM$CNT,    type: UINT64 }
    config:
      file_path: "/workspace/Output/output_query2.csv"
      input_format: CSV

logical:
  - name: SNCB_STREAM
    schema:
      - { name: TIME_UTC,   type: UINT64 }
      - { name: DEVICE_ID,  type: UINT64 }
      - { name: VBAT,       type: FLOAT64 }
      - { name: PCFA_MBAR,  type: FLOAT64 }
      - { name: PCFF_MBAR,  type: FLOAT64 }
      - { name: PCF1_MBAR,  type: FLOAT64 }
      - { name: PCF2_MBAR,  type: FLOAT64 }
      - { name: T1_MBAR,    type: FLOAT64 }
      - { name: T2_MBAR,    type: FLOAT64 }
      - { name: CODE1,      type: FLOAT64 }
      - { name: CODE2,      type: FLOAT64 }
      - { name: GPS_SPEED,  type: FLOAT64 }
      - { name: GPS_LAT,    type: FLOAT64 }
      - { name: GPS_LON,    type: FLOAT64 }

physical:
  - logical: SNCB_STREAM
    type: TCP
    parser_config:
      type: CSV
      field_delimiter: ","
      tuple_delimiter: "\n"
    source_config:
      socket_host: "host.docker.internal"
      socket_port: "32324"
      socket_type: "SOCK_STREAM"
      socket_domain: "AF_INET"
