# name: sncb_brake
# description: Brake pressure check
# groups: [SNCB]

CREATE LOGICAL SOURCE gps_data(
  device_id UINT64,
  timestamp UINT64,
  PCFA FLOAT64,
  PCFF FLOAT64,
  PCF1 FLOAT64,
  PCF2 FLOAT64,
  T1 FLOAT64,
  T2 FLOAT64,
  Code1 UINT64,
  Code2 UINT64
);
CREATE PHYSICAL SOURCE FOR gps_data TYPE File;
ATTACH INLINE
5,1726972591,3.0,3.860,3.082,3.018,38.68,3.606,0,1024
5,1726972592,3.2,3.865,3.082,3.018,38.75,3.618,0,1024
5,1726972593,3.5,3.862,3.082,3.026,38.68,3.6,0,1024
5,1726972594,3.3,3.864,3.082,3.026,38.75,3.6,0,1024
5,1726972595,3.1,3.861,3.082,3.026,38.75,3.6,0,1024
5,1726972596,3.4,3.863,3.082,3.026,38.75,3.6,0,1024

CREATE SINK brake_sink(gps_data.start UINT64, gps_data.end UINT64, gps_data.PCFA_VAR FLOAT64, gps_data.PCFF_VAR FLOAT64) TYPE File;

SELECT start, end, PCFA_VAR, PCFF_VAR FROM (
    SELECT start, end, VAR(PCFA) AS PCFA_VAR, VAR(PCFF) AS PCFF_VAR 
    FROM gps_data
    WINDOW SLIDING(timestamp, SIZE 10 SEC, ADVANCE BY 5 SEC)
) WHERE (PCFA_VAR > FLOAT64(0.4)) AND (PCFF_VAR <= FLOAT64(0.1))
INTO brake_sink;

----
1726965000,1726975000,0.5,0.005
1726970000,1726980000,0.5,0.005
